{% extends 'hospital/pharmacist_base.html' %}
{% block content %}
{% load static %}

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="//cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
  <script src="//cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
  <style>
    a:link {
      text-decoration: none;
    }

    h6 {
      text-align: center;
      font-size: 1.2em;
    }

    .table-responsive {
      text-wrap: wrap;
      
    }

    .view-doctor-panel{
      width: 100%;
      height: 100%;
      position: relative;
      margin: 1px 1px 1px 1px;
    }

    /* Media Query for smaller screens */
    @media only screen and (max-width: 768px) {
      /* Adjust table font size for smaller screens */
      table {
        font-size: 0.5rem; /* Adjust this value as needed */
      }

      /* Adjust th and td padding for smaller screens */
      th,
      td {
        padding: 0.10rem; /* Adjust this value as needed */
      }
    }

    /* Media Query for larger screens */
    @media only screen and (min-width: 768px) {
      /* Adjust table font size for larger screens */
      table {
        font-size: 0.825rem; /* Adjust this value as needed */
      }

      /* Adjust th and td padding for larger screens */
      th,
      td {
        padding: 0.75rem; /* Adjust this value as needed */
      }
    }

  </style>
</head>
<br><br>
<div class="container-fluid">
  <div class="card border border-dark">
    <div class="card-header bg-primary text-white">
      <h6 class="card-title">Manufacturers</h6>
    </div>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
      <div class="container-fluid">
        <button id="addManufacturerBtn" type="button" class="nav-item btn btn-primary"><i class="bi bi-plus"></i></button>
      </div>
    </nav>
    <div class="table-responsive p-4">
      <table class="table table-hover py-3" id="dev-table">
        <thead class="table-dark">
          <tr class="row">
            <th class="col text-truncate">Name</th>
            <th class="col text-truncate">Address</th>
            <th class="col text-truncate">Contact</th>
            <th class="col text-truncate">Update</th>
            <th class="col text-truncate">Delete</th>
          </tr>
        </thead>
        <tbody>
          {% for m in manufacturers %}
          <tr class="row">
            <td class="col text-truncate">{{ m.name }}</td>
            <td class="col text-truncate">{{ m.address }}</td>
            <td class="col text-truncate">{{ m.contact_number }}</td>
            <td class="col text-truncate">
              <a class="btn btn-secondary btn-sm w-100 h-100 updateManufacturerBtn" href="#" 
                 data-manufacturer-id="{{ m.id }}" 
                 data-manufacturer-name="{{ m.name }}"
                 data-manufacturer-address="{{ m.address }}"
                 data-manufacturer-contact="{{ m.contact_number }}">
                <i class="bi bi-pencil"></i>
              </a>
            </td>
            <td class="col text-truncate">
              <button class="btn btn-danger btn-sm w-100 h-100 deleteManufacturerBtn" 
                      data-manufacturer-id="{{ m.id }}">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Add Manufacturer Modal Form -->
<div class="modal fade" id="addManufacturerModal" tabindex="-1" aria-labelledby="addManufacturerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addManufacturerModalLabel">Add Manufacturer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="manufacturerForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="manufacturerName" class="form-label">Name</label>
            <input type="text" class="form-control" id="manufacturerName" name="manufacturerName" required>
          </div>
          <div class="mb-3">
            <label for="manufacturerAddress" class="form-label">Address</label>
            <input type="text" class="form-control" id="manufacturerAddress" name="manufacturerAddress" required>
          </div>
          <div class="mb-3">
            <label for="manufacturerContact" class="form-label">Contact Number</label>
            <input type="text" class="form-control" id="manufacturerContact" name="manufacturerContact" required>
          </div>
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Update Manufacturer Modal Form -->
<div class="modal fade" id="updateManufacturerModal" tabindex="-1" aria-labelledby="addManufacturerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="updateManufacturerModalLabel">Update Manufacturer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="updateManufacturerForm">
          {% csrf_token %}
          <!-- Hidden input field to store the manufacturer ID -->
          <input type="hidden" id="manufacturerId" name="manufacturerId" value="">
          <div class="mb-3">
            <label for="manufacturerName" class="form-label">Name</label>
            <input type="text" class="form-control" id="updateManufacturerName" name="manufacturerName" required>
          </div>
          <div class="mb-3">
            <label for="manufacturerAddress" class="form-label">Address</label>
            <input type="text" class="form-control" id="updateManufacturerAddress" name="manufacturerAddress" required>
          </div>
          <div class="mb-3">
            <label for="manufacturerContact" class="form-label">Contact Number</label>
            <input type="text" class="form-control" id="updateManufacturerContact" name="manufacturerContact" required>
          </div>
          <button type="submit" class="btn btn-primary">Update</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  //Add New Manufacturer
  $(document).ready(function() {
    // Initialize DataTable
    let table = $('#dev-table').DataTable();

    // Show modal when add manufacturer button is clicked
    $('#addManufacturerBtn').click(function() {
      $('#addManufacturerModal').modal('show');
    });

    // Handle form submission with SweetAlert2
    $('#manufacturerForm').submit(function(e) {
      e.preventDefault();
      let formData = $(this).serializeArray();
      let manufacturerData = {};
      formData.forEach(item => {
        manufacturerData[item.name] = item.value;
      });

      // Submit form data to the current view URL
      $.ajax({
        type: 'POST',
        url: '{% url "pharmacist-manufacturers-view" %}',
        data: $(this).serialize(),
        success: function(response) {
          // Handle success response
          Swal.fire({
            icon: 'success',
            title: 'Manufacturer Added!',
            showConfirmButton: false,
            timer: 1500,
            willClose: function() {

              // Reset form
              $('#manufacturerForm')[0].reset();

              // Close modal & Reload the Page
              $('#addManufacturerModal').modal('hide');
              window.location.reload()
            }
          });
        },
        error: function(xhr, status, error) {
          // Handle error response
          console.error(xhr.responseText);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred. Please try again later.',
          });
        }
      });
    });
  });

  //Update Manufacturer Form
  $(document).ready(function() {
    // Show modal and populate form fields when update manufacturer button is clicked
    $('.updateManufacturerBtn').click(function(e) {
      e.preventDefault();
      var manufacturerId = $(this).data('manufacturer-id');
      var manufacturerName = $(this).data('manufacturer-name');
      var manufacturerAddress = $(this).data('manufacturer-address');
      var manufacturerContact = $(this).data('manufacturer-contact');

      $('#manufacturerId').val(manufacturerId); // Set the manufacturer ID in hidden input
      $('#updateManufacturerName').val(manufacturerName);
      $('#updateManufacturerAddress').val(manufacturerAddress);
      $('#updateManufacturerContact').val(manufacturerContact);

      // Show update manufacturer modal
      $('#updateManufacturerModal').modal('show');
    });

    // Handle form submission with SweetAlert2
    $('#updateManufacturerForm').submit(function(e) {
      e.preventDefault();
      let formData = $(this).serializeArray();
      let manufacturerData = {};
      formData.forEach(item => {
        manufacturerData[item.name] = item.value;
      });

      // Submit form data to the update view URL
      $.ajax({
        type: 'POST',
        url: '{% url "pharmacist-manufacturers-update" %}',
        data: $(this).serialize(),
        success: function(response) {
          // Handle success response
          Swal.fire({
            icon: 'success',
            title: response.message,
            showConfirmButton: false,
            timer: 1500,
            willClose: function() {
              // Reload the page after successful update
              window.location.reload();
            }
          });
        },
        error: function(xhr, status, error) {
          // Handle error response
          console.error(xhr.responseText);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred. Please try again later.',
          });
        }
      });
    });
  });

  //Delete Manufacturer
  $(document).ready(function() {
    // Delete manufacturer when delete button is clicked
    $('.deleteManufacturerBtn').click(function(e) {
      e.preventDefault();
      var manufacturerId = $(this).data('manufacturer-id');

      // Confirm deletion
      Swal.fire({
        title: 'Are you sure?',
        text: 'You will not be able to recover this manufacturer!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'No, cancel!',
        reverseButtons: true
      }).then((result) => {
        if (result.isConfirmed) {
          // Send AJAX request to delete the manufacturer
          $.ajax({
            type: 'POST',
            url: '{% url "pharmacist-manufacturers-delete" %}',
            data: {'manufacturerId': manufacturerId},
            beforeSend: function(xhr, settings) {
              xhr.setRequestHeader('X-CSRFToken', $('input[name="csrfmiddlewaretoken"]').val());
            },
            success: function(response) {
              // Handle success response
              Swal.fire({
                icon: 'success',
                title: response.message,
                showConfirmButton: false,
                timer: 1500,
                willClose: function() {
                  // Reload the page after successful deletion
                  window.location.reload();
                }
              });
            },
            error: function(xhr, status, error) {
              // Handle error response
              console.error(xhr.responseText);
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'An error occurred. Please try again later.',
              });
            }
          });
        } else if (result.dismiss === Swal.DismissReason.cancel) {
          // Do nothing on cancel
        }
      });
    });
  });

</script>

{% endblock content %}
